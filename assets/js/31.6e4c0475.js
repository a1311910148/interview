(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{443:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#需求"}},[t._v("需求")])]),s("li",[s("a",{attrs:{href:"#错误尝试"}},[t._v("错误尝试")])]),s("li",[s("a",{attrs:{href:"#开发环境-windows"}},[t._v("开发环境（Windows）")]),s("ul",[s("li",[s("a",{attrs:{href:"#直接使用dom分析视频标签"}},[t._v("直接使用dom分析视频标签")])]),s("li",[s("a",{attrs:{href:"#拦截接口"}},[t._v("拦截接口")])]),s("li",[s("a",{attrs:{href:"#添加前端页面完善接口"}},[t._v("添加前端页面完善接口")])])])]),s("li",[s("a",{attrs:{href:"#服务端部署-linux"}},[t._v("服务端部署（Linux）")]),s("ul",[s("li",[s("a",{attrs:{href:"#其他"}},[t._v("其他")])])])]),s("li",[s("a",{attrs:{href:"#代码"}},[t._v("代码")])]),s("li",[s("a",{attrs:{href:"#总结"}},[t._v("总结")])])])]),s("p"),t._v(" "),s("h2",{attrs:{id:"需求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[t._v("#")]),t._v(" 需求")]),t._v(" "),s("p",[t._v("项目需求是提供一个接口通过输入一个网页地址，抓取网页中的视频地址！例如打开一个 "),s("a",{attrs:{href:"https://link.segmentfault.com/?enc=X59sfk%2B%2FlEbxqrSIBPkHsQ%3D%3D.eWSlQ%2FHC7LTXjEsoPcXczx62E2sLdBmsLqkZKzudvSAKdLefW9JDubNWT79bsu0L6eAnetSSvdFOK59RBYEltw%3D%3D",target:"_blank",rel:"noopener noreferrer"}},[t._v("网页地址"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxfd",alt:"image.png"}})]),t._v(" "),s("p",[t._v("需要将网页中的视频地址提取出来。作为前端开发人员的惯性思维，看到这个网页的html结构，这个不是很简单嘛，一行代码就搞定："),s("code",[t._v("document.querySelector('video source').src")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxfW",alt:"image.png"}})]),t._v(" "),s("p",[t._v("嘻嘻，大功告成，准备摸鱼~")]),t._v(" "),s("p",[t._v("等等！这个只是在浏览器的控制台中拿到了视频的地址，但是如何转化成为提供一个接口，通过接口返回这个地址呢？初步猜想，使用get请求获取网页的html，然后分析dom结构，解析出video标签。")]),t._v(" "),s("h2",{attrs:{id:"错误尝试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#错误尝试"}},[t._v("#")]),t._v(" 错误尝试")]),t._v(" "),s("p",[t._v("直接通过get请求页面的地址获取到的内容并不是我们在浏览器所看到的内容。目前的网页大多都是动态网页，即页面最终呈现的内容是通过加载"),s("code",[t._v("js")]),t._v("后执行脚本动态拼接的，因此页面中的"),s("code",[t._v("video")]),t._v("标签并不是直接从服务端拼接好的。")]),t._v(" "),s("p",[t._v("浏览器加载网页的请求截图，没有直接返回dom结构，全是加载一堆js和css文件")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxnf",alt:"image.png"}})]),t._v(" "),s("p",[t._v("并且！很多网站都做了防爬措施，直接请求页面的地址会返回一个中间页面，例如抖音和微博的视频详情页面，直接请求会返回一个类似于认证的页面，初步分析了这个页面，这个中转页面应该是判断有没有相应"),s("code",[t._v("cookie")]),t._v("的信息，如果没有相应的信息，就会给浏览器设置"),s("code",[t._v("cookie")]),t._v("之类的信息，最后会走一个"),s("code",[t._v("window.location.reload();")]),t._v("让页面刷新一次（微博会直接走到一个"),s("code",[t._v("Sina Visitor System")]),t._v("的页面不会直接跳转到详情页面）。这个脚本在浏览器中会自动执行，因此会重新加载一次，看到最终的详情页面。但是get请求仅仅是获取到了中转页面的html，并没有走到真正的详情页面。")]),t._v(" "),s("p",[t._v("抖音详情页面get请求\n"),s("a",{attrs:{href:"https://link.segmentfault.com/?enc=IwUAs6snEnBHag9plH80PA%3D%3D.cnkzBmFTD917twjeAlJakgqvWXT6oHl2cg0Ws6FhZDcuPDn2j1OkNft8V9mJTp8mVGSv%2FbpGMsScXxMByDCPtg%3D%3D",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.douyin.com/video/7020764246476590339"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxof",alt:"image.png"}})]),t._v(" "),s("p",[t._v("微博详情页面get请求\n"),s("a",{attrs:{href:"https://link.segmentfault.com/?enc=TdJleVPd%2FRgFudO3RFMFDQ%3D%3D.O0HS7BvkhDzhbbFDNQ7oakGQjALYJpO5XMXg7qXNLRLQO5ng48v1AZORdna8G7TIEQ1w6grXvhy8R1ISq6zDo3f%2FmwXHljBeCQni6EUlUlk%3D",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://weibo.com/tv/show/1034:4699424946061376?mid=4699425262272582"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxmt",alt:"image.png"}})]),t._v(" "),s("p",[t._v("哎呀！连最终的网页信息都拿不到，怎么可能拿到页面视频地址呢？这下可不能愉快的摸鱼了")]),t._v(" "),s("p",[t._v("通过调研后决定采用 "),s("code",[t._v("Node.js")]),t._v(" + "),s("code",[t._v("Puppeteer")]),t._v("来实现这个功能，本文主要记录项目的实现思路和开发部署中遇到的难点及其解决方案，仅供学习参考。")]),t._v(" "),s("blockquote",[s("p",[t._v("Puppeteer 是 Chrome 开发团队在 2017 年发布的一个 Node.js 包，用来模拟 Chrome 浏览器的运行.主要通过Puppeteer运行Chromium加载网页实现分析页面dom获取video标签，实现视频地址抓取")])]),t._v(" "),s("p",[t._v("参考资料：")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://link.segmentfault.com/?enc=bq3i%2FLiTzV65oloap1fJKw%3D%3D.x105VYvhE7QZ7vYxore7MZ2UOOZsX8yq%2Bwm48K%2FVMRYRAgqaLx6N42tQL7qQXBfUwu9v8XeZHYLHfbt7Scp4llu%2FkHlFJJlWv7W%2FOFF3Hi%2FbNrwg59yTZII6gKaqEDKB",target:"_blank",rel:"noopener noreferrer"}},[t._v("Puppeteer中文文档"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://link.segmentfault.com/?enc=2at3dd5PlUCbPJc1xKnWrw%3D%3D.2NFzguVkr8JSqmJwGnfjqCrzMsgFwYbT7XGeccVtoRTRrf%2FD%2FsQfQ598oyPHi4Vh",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/puppeteer/puppeteer"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"开发环境-windows"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发环境-windows"}},[t._v("#")]),t._v(" 开发环境（Windows）")]),t._v(" "),s("p",[t._v("决定使用"),s("code",[t._v("puppeteerjs")]),t._v("后里面在windows环境下进行开发，\nwindows环境为"),s("code",[t._v("Node v12.16.2")]),t._v(", "),s("code",[t._v("puppeteerjs v2.1.1")])]),t._v(" "),s("p",[s("code",[t._v("puppeteerjs")]),t._v("的最新版为"),s("code",[t._v("13.1.1")]),t._v("。但是"),s("code",[t._v("puppeteerjs v3.0")]),t._v("版本及以上需要"),s("code",[t._v("Node v10")]),t._v("及以上,因为我本地的开发环境Node为v12,服务器上的Node为v8，因此本地开发没问题，但是服务器上一直部署不成功，且服务器上面有很多其他项目都是基于node v8版本的，因此服务器上的node版本不宜升级。为保持和服务器版本一致，windows环境下的"),s("code",[t._v("puppeteerjs")]),t._v("也使用"),s("code",[t._v("2.1.1版本")]),t._v(";")]),t._v(" "),s("p",[t._v("直接上代码\nserver2.js")]),t._v(" "),s("div",{staticClass:"language-qml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-qml"}},[s("code",[t._v("const puppeteer = require('puppeteer')"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nasync function getVideoUrl () "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    const browser = await puppeteer.launch()"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 打开浏览器")]),t._v("\n    const page = await browser.newPage()"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    await page.emulate(puppeteer.devices"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("'iPhone 6'"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(")\n    await page.goto('https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//www.douyin.com/video/7020764246476590339'); // 跳转到指定页面")]),t._v("\n    await page.waitFor(2000)  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 延时2s加载页面 puppeteer2.1.1使用 waitFor ^13.0.1以上使用 waitForTimeout  ")]),t._v("\n    const pageHtml = await page.content()"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取页面html Gets the full HTML contents of the page, including the doctype.")]),t._v("\n    console.log(pageHtml)"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ngetVideoUrl()\n")])])]),s("p",[t._v("执行"),s("code",[t._v("node server2.js")]),t._v("，输出的结果就是详情页面的html代码了")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxtj",alt:"image.png"}})]),t._v(" "),s("p",[s("code",[t._v("puppeteer.launch")]),t._v("中的"),s("code",[t._v("headless")]),t._v("默认"),s("code",[t._v("true")]),t._v(",如果设置为"),s("code",[t._v("false")]),t._v(",会打开一个"),s("code",[t._v("Chromium")]),t._v("加载网页,并且能直接调试网页！")]),t._v(" "),s("div",{staticClass:"language-csharp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-csharp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" puppeteer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("launch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    headless"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否无头浏览")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxAP",alt:"image.png"}})]),t._v(" "),s("p",[t._v("拿到了html代码我们怎么进一步获取video标签呢？")]),t._v(" "),s("h3",{attrs:{id:"直接使用dom分析视频标签"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#直接使用dom分析视频标签"}},[t._v("#")]),t._v(" 直接使用dom分析视频标签")]),t._v(" "),s("p",[s("code",[t._v("puppeteer")]),t._v("给我们提供了相应的api，因为浏览器渲染dom已经请求接口需要时间，因为第一时间我们拿到都网页代码也不是完整的，因此我们需要加延时。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("waitForTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 延时2s加载页面 puppeteer2.1.1使用 waitFor ^13.0.1以上使用 waitForTimeout  ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" videoSrc "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" page"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("$eval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'video source'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("el")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" src "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("el "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" el"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        src "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" el"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" src"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"拦截接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拦截接口"}},[t._v("#")]),t._v(" 拦截接口")]),t._v(" "),s("p",[t._v("部分页面是直接通过请求接口获取到的视频地址，对于这种网页我们可以使用上面的方法，等页面加载完毕后分析"),s("code",[t._v("dom")]),t._v("，但是查阅puppeteer的文档时发现可以直接拦截接口，获取接口的返回信息,\n因此，如果我们针对指定的详情，知道其请求规则，可以直接通过接口响应获取相应的数据。")]),t._v(" "),s("div",{staticClass:"language-dart extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dart"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注册响应监听事件")]),t._v("\npage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'response'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ok")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" request "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" reqUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reqUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("indexOf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/getHttpVideoInfo.do'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拦截 /api/getHttpVideoInfo.do 接口")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" respData "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("json")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" video "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" respData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("video"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("video "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" video"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("validChapterNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" currentChapter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" video"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("`chapters$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("video"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("validChapterNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("`"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("currentChapter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" currentChapter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" currentChapter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" currentChapter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("currentChapter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("这种方式是指针对有明确接口，切能拿到相应的请求参数的页面使用！")]),t._v(" "),s("h3",{attrs:{id:"添加前端页面完善接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加前端页面完善接口"}},[t._v("#")]),t._v(" 添加前端页面完善接口")]),t._v(" "),s("p",[t._v("完整的代码已提交到github，链接在后面给出")]),t._v(" "),s("p",[t._v("打开本地网页访问：localhost:18000\n"),s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxw2",alt:"image.png"}})]),t._v(" "),s("h2",{attrs:{id:"服务端部署-linux"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务端部署-linux"}},[t._v("#")]),t._v(" 服务端部署（Linux）")]),t._v(" "),s("p",[t._v("服务端环境为linux环境，系统为CentOS-8，Node.js 版本为 "),s("code",[t._v("v8.11.3")]),t._v(",Linux环境和windows环境部署的时候有点区别，特别是安装"),s("code",[t._v("puppeteer")]),t._v("时需要注意\n安装"),s("code",[t._v("puppeteer")]),t._v("时会报以下错误")]),t._v(" "),s("div",{staticClass:"language-subunit extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("ERROR: Failed to download Chromium r722234! Set \"PUPPETEER_SKIP_CHROMIUM_DOWNLOAD\" env variable to skip download.\nError: EACCES: permission denied, mkdir '/opt/video-url-analysis/node_modules/puppeteer/.local-chromium'\n")])])]),s("p",[s("img",{attrs:{src:"https://segmentfault.com/img/bVcXxu8",alt:"image.png"}})]),t._v(" "),s("p",[t._v("因为安装"),s("code",[t._v("puppeteer")]),t._v("时会安装"),s("code",[t._v("Chromium")]),t._v("，需要权限，因此在linux环境下使用以下命令安装")]),t._v(" "),s("div",{staticClass:"language-apache extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npm install puppeteer@2.1.1 --unsafe-perm=true --allow-root\n")])])]),s("p",[t._v("安装完毕后启动程序，成功运行并抓取网页视频！")]),t._v(" "),s("h3",{attrs:{id:"其他"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[t._v("#")]),t._v(" 其他")]),t._v(" "),s("p",[t._v("linux下启动浏览器 "),s("code",[t._v("headless")]),t._v("需要设置为"),s("code",[t._v("true")]),t._v(",添加"),s("code",[t._v("args")]),t._v("参数")]),t._v(" "),s("div",{staticClass:"language-aspectj extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("const browser = await puppeteer.launch({\n    headless: true, // 是否启用无头浏览 默认为true\n    args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox'\n    ]\n});\n")])])]),s("p",[t._v("其他异常错误：\n1."),s("code",[t._v("Failed to launch the browser process")])]),t._v(" "),s("div",{staticClass:"language-subunit extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Failed to launch the browser process\n...\nerror while loading shared libraries: libXss.so.1: cannot open shared object file: No such file or directory\n")])])]),s("p",[t._v("应该是系统缺少某些库或者组件（我这边使用命令后解决了这个问题）")]),t._v(" "),s("div",{staticClass:"language-apache extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("sudo yum -y install libXScrnSaver-1.2.2-6.1.el7.x86_64\n")])])]),s("p",[t._v("或者直接重新安装chromium，手动安装chromium后解决问题")]),t._v(" "),s("div",{staticClass:"language-cmake extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cmake"}},[s("code",[t._v("sudo yum install -y chromium\n")])])]),s("p",[t._v("2.使用yum安装软件依赖出错，一直提示找不到软件包")]),t._v(" "),s("div",{staticClass:"language-makefile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-makefile"}},[s("code",[t._v("[root"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("@")]),t._v("localhost video-url-analysis]"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sudo yum install -y chromium")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token target symbol"}},[t._v("上次元数据过期检查：0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("00"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("47 前，执行于 2022年01月20日 星期四 21时35分27秒。\n"),s("span",{pre:!0,attrs:{class:"token target symbol"}},[t._v("未找到匹配的参数")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" chromium\n"),s("span",{pre:!0,attrs:{class:"token target symbol"}},[t._v("错误：没有任何匹配")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" chromium\n")])])]),s("p",[t._v("原因是"),s("code",[t._v("CentOS 8")]),t._v("没有安装 "),s("code",[t._v("epel")]),t._v(" 源的问题,安装 "),s("code",[t._v("epel")]),t._v(" 源后问题解决:\n"),s("code",[t._v("yum install epel-release")])]),t._v(" "),s("h2",{attrs:{id:"代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#代码"}},[t._v("#")]),t._v(" 代码")]),t._v(" "),s("p",[t._v("完整代码已上传 "),s("a",{attrs:{href:"https://link.segmentfault.com/?enc=pYKcxvwAdhoIiBSZFUdgfA%3D%3D.P%2B%2BR5euwxF8SgVmPH67B3wqPxguuZHJVxjkYzlYmLDbYqJW7dROAxDIwZVHx9UG8",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/zhaosheng808/video-grab"),s("OutboundLink")],1),t._v(" 欢迎 star，仅供学习参考,切勿用于非法途径")]),t._v(" "),s("p",[t._v("1.安装依赖")]),t._v(" "),s("div",{staticClass:"language-cmake extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cmake"}},[s("code",[t._v("npm install\n")])])]),s("p",[t._v("2.本地开发")]),t._v(" "),s("div",{staticClass:"language-routeros extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("npm run dev\n")])])]),s("p",[t._v("打开本地网页访问：localhost:18000")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("windows环境下开发比较顺利，由于本人是前端切图仔，服务器接触较少，所以linux服务端部署遇到的问题较多，因此记录一下解决问题的过程，方便后续开发者遇到问题能够顺利解决。\n服务端知识有所欠缺，如有不足，还请海涵！")])])}),[],!1,null,null,null);s.default=n.exports}}]);