<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js使用puppeteerjs提取网页中的内容 | 我的博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="XXX">
    
    <link rel="preload" href="/interview/assets/css/0.styles.7bcb96c2.css" as="style"><link rel="preload" href="/interview/assets/js/app.8b7001fa.js" as="script"><link rel="preload" href="/interview/assets/js/3.09e61146.js" as="script"><link rel="preload" href="/interview/assets/js/1.645caf6f.js" as="script"><link rel="preload" href="/interview/assets/js/31.6e4c0475.js" as="script"><link rel="prefetch" href="/interview/assets/js/10.2850c218.js"><link rel="prefetch" href="/interview/assets/js/11.d385cf98.js"><link rel="prefetch" href="/interview/assets/js/12.d30c7716.js"><link rel="prefetch" href="/interview/assets/js/13.aa59dd2b.js"><link rel="prefetch" href="/interview/assets/js/14.30c19909.js"><link rel="prefetch" href="/interview/assets/js/15.f6ae54d5.js"><link rel="prefetch" href="/interview/assets/js/16.cf6e60f2.js"><link rel="prefetch" href="/interview/assets/js/17.25b3e831.js"><link rel="prefetch" href="/interview/assets/js/18.54c0ddbe.js"><link rel="prefetch" href="/interview/assets/js/19.b825fdc2.js"><link rel="prefetch" href="/interview/assets/js/20.cd5870ba.js"><link rel="prefetch" href="/interview/assets/js/21.71580b2c.js"><link rel="prefetch" href="/interview/assets/js/22.cced48d7.js"><link rel="prefetch" href="/interview/assets/js/23.c5228822.js"><link rel="prefetch" href="/interview/assets/js/24.478e72eb.js"><link rel="prefetch" href="/interview/assets/js/25.3192440f.js"><link rel="prefetch" href="/interview/assets/js/26.8ed0b81c.js"><link rel="prefetch" href="/interview/assets/js/27.4532e80e.js"><link rel="prefetch" href="/interview/assets/js/28.c59f7355.js"><link rel="prefetch" href="/interview/assets/js/29.d0784306.js"><link rel="prefetch" href="/interview/assets/js/30.72641b5f.js"><link rel="prefetch" href="/interview/assets/js/32.8e3cf05d.js"><link rel="prefetch" href="/interview/assets/js/33.d3688fde.js"><link rel="prefetch" href="/interview/assets/js/34.5da46ad9.js"><link rel="prefetch" href="/interview/assets/js/35.bb67e589.js"><link rel="prefetch" href="/interview/assets/js/36.3f091898.js"><link rel="prefetch" href="/interview/assets/js/37.ccba1dd6.js"><link rel="prefetch" href="/interview/assets/js/38.55bad300.js"><link rel="prefetch" href="/interview/assets/js/39.1d680a34.js"><link rel="prefetch" href="/interview/assets/js/4.149f90e4.js"><link rel="prefetch" href="/interview/assets/js/5.c490b3e4.js"><link rel="prefetch" href="/interview/assets/js/6.7e5c0638.js"><link rel="prefetch" href="/interview/assets/js/7.458a7545.js"><link rel="prefetch" href="/interview/assets/js/8.093c9de9.js"><link rel="prefetch" href="/interview/assets/js/9.241cfaec.js">
    <link rel="stylesheet" href="/interview/assets/css/0.styles.7bcb96c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-6853d236><div data-v-6853d236><div class="password-shadow password-wrapper-out" style="display:none;" data-v-2d5d5590 data-v-6853d236 data-v-6853d236><h3 class="title" data-v-2d5d5590>我的博客</h3> <p class="description" data-v-2d5d5590>XXX</p> <label id="box" class="inputBox" data-v-2d5d5590><input type="password" value="" data-v-2d5d5590> <span data-v-2d5d5590>Konck! Knock!</span> <button data-v-2d5d5590>OK</button></label> <div class="footer" data-v-2d5d5590><span data-v-2d5d5590><i class="iconfont reco-theme" data-v-2d5d5590></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-2d5d5590>vuePress-theme-reco</a></span> <span data-v-2d5d5590><i class="iconfont reco-copyright" data-v-2d5d5590></i> <a data-v-2d5d5590><!---->
          
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-6853d236><header class="navbar" data-v-6853d236><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/interview/" class="home-link router-link-active"><!----> <span class="site-name">我的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      song的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/726107228492253" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/gemini-hjl" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-6853d236></div> <aside class="sidebar" data-v-6853d236><div class="personal-info-wrapper" data-v-3c280276 data-v-6853d236><!----> <!----> <div class="num" data-v-3c280276><div data-v-3c280276><h3 data-v-3c280276>22</h3> <h6 data-v-3c280276>文章</h6></div> <div data-v-3c280276><h3 data-v-3c280276>0</h3> <h6 data-v-3c280276>标签</h6></div></div> <ul class="social-links" data-v-3c280276></ul> <hr data-v-3c280276></div> <nav class="nav-links"><div class="nav-item"><a href="/interview/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      song的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/726107228492253" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/gemini-hjl" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/interview/" class="sidebar-heading clickable router-link-active"><span>欢迎学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/" aria-current="page" class="sidebar-link">博客简介</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/1-base/css" class="sidebar-heading clickable"><span>web基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/2-Vue/base" class="sidebar-heading clickable"><span>Vue框架</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/3-node/Node-Modules" class="sidebar-heading clickable"><span>node服务端</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/4-demo/puppeteerjs" class="sidebar-heading clickable open active"><span>用例收集</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/4-demo/puppeteerjs.html" aria-current="page" class="active sidebar-link">node puppeteerjs模块爬取页面</a></li><li><a href="/interview/4-demo/docker-mysql.html" class="sidebar-link">Docker部署MySQL服务</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/5-over-the-wall/internet" class="sidebar-heading clickable"><span>科学上网</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-2d5d5590 data-v-6853d236><h3 class="title" data-v-2d5d5590>Node.js使用puppeteerjs提取网页中的内容</h3> <!----> <label id="box" class="inputBox" data-v-2d5d5590><input type="password" value="" data-v-2d5d5590> <span data-v-2d5d5590>Konck! Knock!</span> <button data-v-2d5d5590>OK</button></label> <div class="footer" data-v-2d5d5590><span data-v-2d5d5590><i class="iconfont reco-theme" data-v-2d5d5590></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-2d5d5590>vuePress-theme-reco</a></span> <span data-v-2d5d5590><i class="iconfont reco-copyright" data-v-2d5d5590></i> <a data-v-2d5d5590><!---->
          
        <!---->
        2022
      </a></span></div></div> <div data-v-6853d236><div data-v-6853d236><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">Node.js使用puppeteerjs提取网页中的内容</h1> <div data-v-305db890><i class="iconfont reco-account" data-v-305db890><span data-v-305db890>codinglin</span></i> <i class="iconfont reco-date" data-v-305db890><span data-v-305db890>2022/8/28</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#需求">需求</a></li><li><a href="#错误尝试">错误尝试</a></li><li><a href="#开发环境-windows">开发环境（Windows）</a><ul><li><a href="#直接使用dom分析视频标签">直接使用dom分析视频标签</a></li><li><a href="#拦截接口">拦截接口</a></li><li><a href="#添加前端页面完善接口">添加前端页面完善接口</a></li></ul></li><li><a href="#服务端部署-linux">服务端部署（Linux）</a><ul><li><a href="#其他">其他</a></li></ul></li><li><a href="#代码">代码</a></li><li><a href="#总结">总结</a></li></ul></div><p></p> <h2 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h2> <p>项目需求是提供一个接口通过输入一个网页地址，抓取网页中的视频地址！例如打开一个 <a href="https://link.segmentfault.com/?enc=X59sfk%2B%2FlEbxqrSIBPkHsQ%3D%3D.eWSlQ%2FHC7LTXjEsoPcXczx62E2sLdBmsLqkZKzudvSAKdLefW9JDubNWT79bsu0L6eAnetSSvdFOK59RBYEltw%3D%3D" target="_blank" rel="noopener noreferrer">网页地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://segmentfault.com/img/bVcXxfd" alt="image.png"></p> <p>需要将网页中的视频地址提取出来。作为前端开发人员的惯性思维，看到这个网页的html结构，这个不是很简单嘛，一行代码就搞定：<code>document.querySelector('video source').src</code></p> <p><img src="https://segmentfault.com/img/bVcXxfW" alt="image.png"></p> <p>嘻嘻，大功告成，准备摸鱼~</p> <p>等等！这个只是在浏览器的控制台中拿到了视频的地址，但是如何转化成为提供一个接口，通过接口返回这个地址呢？初步猜想，使用get请求获取网页的html，然后分析dom结构，解析出video标签。</p> <h2 id="错误尝试"><a href="#错误尝试" class="header-anchor">#</a> 错误尝试</h2> <p>直接通过get请求页面的地址获取到的内容并不是我们在浏览器所看到的内容。目前的网页大多都是动态网页，即页面最终呈现的内容是通过加载<code>js</code>后执行脚本动态拼接的，因此页面中的<code>video</code>标签并不是直接从服务端拼接好的。</p> <p>浏览器加载网页的请求截图，没有直接返回dom结构，全是加载一堆js和css文件</p> <p><img src="https://segmentfault.com/img/bVcXxnf" alt="image.png"></p> <p>并且！很多网站都做了防爬措施，直接请求页面的地址会返回一个中间页面，例如抖音和微博的视频详情页面，直接请求会返回一个类似于认证的页面，初步分析了这个页面，这个中转页面应该是判断有没有相应<code>cookie</code>的信息，如果没有相应的信息，就会给浏览器设置<code>cookie</code>之类的信息，最后会走一个<code>window.location.reload();</code>让页面刷新一次（微博会直接走到一个<code>Sina Visitor System</code>的页面不会直接跳转到详情页面）。这个脚本在浏览器中会自动执行，因此会重新加载一次，看到最终的详情页面。但是get请求仅仅是获取到了中转页面的html，并没有走到真正的详情页面。</p> <p>抖音详情页面get请求
<a href="https://link.segmentfault.com/?enc=IwUAs6snEnBHag9plH80PA%3D%3D.cnkzBmFTD917twjeAlJakgqvWXT6oHl2cg0Ws6FhZDcuPDn2j1OkNft8V9mJTp8mVGSv%2FbpGMsScXxMByDCPtg%3D%3D" target="_blank" rel="noopener noreferrer">https://www.douyin.com/video/7020764246476590339<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://segmentfault.com/img/bVcXxof" alt="image.png"></p> <p>微博详情页面get请求
<a href="https://link.segmentfault.com/?enc=TdJleVPd%2FRgFudO3RFMFDQ%3D%3D.O0HS7BvkhDzhbbFDNQ7oakGQjALYJpO5XMXg7qXNLRLQO5ng48v1AZORdna8G7TIEQ1w6grXvhy8R1ISq6zDo3f%2FmwXHljBeCQni6EUlUlk%3D" target="_blank" rel="noopener noreferrer">https://weibo.com/tv/show/1034:4699424946061376?mid=4699425262272582<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://segmentfault.com/img/bVcXxmt" alt="image.png"></p> <p>哎呀！连最终的网页信息都拿不到，怎么可能拿到页面视频地址呢？这下可不能愉快的摸鱼了</p> <p>通过调研后决定采用 <code>Node.js</code> + <code>Puppeteer</code>来实现这个功能，本文主要记录项目的实现思路和开发部署中遇到的难点及其解决方案，仅供学习参考。</p> <blockquote><p>Puppeteer 是 Chrome 开发团队在 2017 年发布的一个 Node.js 包，用来模拟 Chrome 浏览器的运行.主要通过Puppeteer运行Chromium加载网页实现分析页面dom获取video标签，实现视频地址抓取</p></blockquote> <p>参考资料：</p> <p><a href="https://link.segmentfault.com/?enc=bq3i%2FLiTzV65oloap1fJKw%3D%3D.x105VYvhE7QZ7vYxore7MZ2UOOZsX8yq%2Bwm48K%2FVMRYRAgqaLx6N42tQL7qQXBfUwu9v8XeZHYLHfbt7Scp4llu%2FkHlFJJlWv7W%2FOFF3Hi%2FbNrwg59yTZII6gKaqEDKB" target="_blank" rel="noopener noreferrer">Puppeteer中文文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://link.segmentfault.com/?enc=2at3dd5PlUCbPJc1xKnWrw%3D%3D.2NFzguVkr8JSqmJwGnfjqCrzMsgFwYbT7XGeccVtoRTRrf%2FD%2FsQfQ598oyPHi4Vh" target="_blank" rel="noopener noreferrer">https://github.com/puppeteer/puppeteer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="开发环境-windows"><a href="#开发环境-windows" class="header-anchor">#</a> 开发环境（Windows）</h2> <p>决定使用<code>puppeteerjs</code>后里面在windows环境下进行开发，
windows环境为<code>Node v12.16.2</code>, <code>puppeteerjs v2.1.1</code></p> <p><code>puppeteerjs</code>的最新版为<code>13.1.1</code>。但是<code>puppeteerjs v3.0</code>版本及以上需要<code>Node v10</code>及以上,因为我本地的开发环境Node为v12,服务器上的Node为v8，因此本地开发没问题，但是服务器上一直部署不成功，且服务器上面有很多其他项目都是基于node v8版本的，因此服务器上的node版本不宜升级。为保持和服务器版本一致，windows环境下的<code>puppeteerjs</code>也使用<code>2.1.1版本</code>;</p> <p>直接上代码
server2.js</p> <div class="language-qml extra-class"><pre class="language-qml"><code>const puppeteer = require('puppeteer')<span class="token punctuation">;</span>

async function getVideoUrl () <span class="token punctuation">{</span>
    const browser = await puppeteer.launch()<span class="token punctuation">;</span><span class="token comment">// 打开浏览器</span>
    const page = await browser.newPage()<span class="token punctuation">;</span>
    await page.emulate(puppeteer.devices<span class="token punctuation">[</span>'iPhone 6'<span class="token punctuation">]</span>)
    await page.goto('https<span class="token punctuation">:</span><span class="token comment">//www.douyin.com/video/7020764246476590339'); // 跳转到指定页面</span>
    await page.waitFor(2000)  <span class="token comment">// 延时2s加载页面 puppeteer2.1.1使用 waitFor ^13.0.1以上使用 waitForTimeout  </span>
    const pageHtml = await page.content()<span class="token punctuation">;</span> <span class="token comment">// 获取页面html Gets the full HTML contents of the page, including the doctype.</span>
    console.log(pageHtml)<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
getVideoUrl()
</code></pre></div><p>执行<code>node server2.js</code>，输出的结果就是详情页面的html代码了</p> <p><img src="https://segmentfault.com/img/bVcXxtj" alt="image.png"></p> <p><code>puppeteer.launch</code>中的<code>headless</code>默认<code>true</code>,如果设置为<code>false</code>,会打开一个<code>Chromium</code>加载网页,并且能直接调试网页！</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    headless<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是否无头浏览</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://segmentfault.com/img/bVcXxAP" alt="image.png"></p> <p>拿到了html代码我们怎么进一步获取video标签呢？</p> <h3 id="直接使用dom分析视频标签"><a href="#直接使用dom分析视频标签" class="header-anchor">#</a> 直接使用dom分析视频标签</h3> <p><code>puppeteer</code>给我们提供了相应的api，因为浏览器渲染dom已经请求接口需要时间，因为第一时间我们拿到都网页代码也不是完整的，因此我们需要加延时。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForTimeout</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 延时2s加载页面 puppeteer2.1.1使用 waitFor ^13.0.1以上使用 waitForTimeout  </span>
<span class="token keyword">const</span> videoSrc <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">$eval</span><span class="token punctuation">(</span><span class="token string">'video source'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> src <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        src <span class="token operator">=</span> el<span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> src<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="拦截接口"><a href="#拦截接口" class="header-anchor">#</a> 拦截接口</h3> <p>部分页面是直接通过请求接口获取到的视频地址，对于这种网页我们可以使用上面的方法，等页面加载完毕后分析<code>dom</code>，但是查阅puppeteer的文档时发现可以直接拦截接口，获取接口的返回信息,
因此，如果我们针对指定的详情，知道其请求规则，可以直接通过接口响应获取相应的数据。</p> <div class="language-dart extra-class"><pre class="language-dart"><code><span class="token comment">// 注册响应监听事件</span>
page<span class="token punctuation">.</span><span class="token keyword">on</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'response'</span></span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> request <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> reqUrl <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reqUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'/api/getHttpVideoInfo.do'</span></span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 拦截 /api/getHttpVideoInfo.do 接口</span>
            <span class="token keyword">const</span> respData <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> video <span class="token operator">=</span> respData<span class="token punctuation">.</span>video<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>video <span class="token operator">&amp;&amp;</span> video<span class="token punctuation">.</span>validChapterNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">const</span> currentChapter <span class="token operator">=</span> video<span class="token punctuation">[</span>`chapters$<span class="token punctuation">{</span>video<span class="token punctuation">.</span>validChapterNum<span class="token punctuation">}</span>`<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChapter <span class="token operator">&amp;&amp;</span> currentChapter<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> currentChapter<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> currentChapter<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>currentChapter<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这种方式是指针对有明确接口，切能拿到相应的请求参数的页面使用！</p> <h3 id="添加前端页面完善接口"><a href="#添加前端页面完善接口" class="header-anchor">#</a> 添加前端页面完善接口</h3> <p>完整的代码已提交到github，链接在后面给出</p> <p>打开本地网页访问：localhost:18000
<img src="https://segmentfault.com/img/bVcXxw2" alt="image.png"></p> <h2 id="服务端部署-linux"><a href="#服务端部署-linux" class="header-anchor">#</a> 服务端部署（Linux）</h2> <p>服务端环境为linux环境，系统为CentOS-8，Node.js 版本为 <code>v8.11.3</code>,Linux环境和windows环境部署的时候有点区别，特别是安装<code>puppeteer</code>时需要注意
安装<code>puppeteer</code>时会报以下错误</p> <div class="language-subunit extra-class"><pre class="language-text"><code>ERROR: Failed to download Chromium r722234! Set &quot;PUPPETEER_SKIP_CHROMIUM_DOWNLOAD&quot; env variable to skip download.
Error: EACCES: permission denied, mkdir '/opt/video-url-analysis/node_modules/puppeteer/.local-chromium'
</code></pre></div><p><img src="https://segmentfault.com/img/bVcXxu8" alt="image.png"></p> <p>因为安装<code>puppeteer</code>时会安装<code>Chromium</code>，需要权限，因此在linux环境下使用以下命令安装</p> <div class="language-apache extra-class"><pre class="language-text"><code>npm install puppeteer@2.1.1 --unsafe-perm=true --allow-root
</code></pre></div><p>安装完毕后启动程序，成功运行并抓取网页视频！</p> <h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <p>linux下启动浏览器 <code>headless</code>需要设置为<code>true</code>,添加<code>args</code>参数</p> <div class="language-aspectj extra-class"><pre class="language-text"><code>const browser = await puppeteer.launch({
    headless: true, // 是否启用无头浏览 默认为true
    args: [
        '--no-sandbox',
        '--disable-setuid-sandbox'
    ]
});
</code></pre></div><p>其他异常错误：
1.<code>Failed to launch the browser process</code></p> <div class="language-subunit extra-class"><pre class="language-text"><code>Failed to launch the browser process
...
error while loading shared libraries: libXss.so.1: cannot open shared object file: No such file or directory
</code></pre></div><p>应该是系统缺少某些库或者组件（我这边使用命令后解决了这个问题）</p> <div class="language-apache extra-class"><pre class="language-text"><code>sudo yum -y install libXScrnSaver-1.2.2-6.1.el7.x86_64
</code></pre></div><p>或者直接重新安装chromium，手动安装chromium后解决问题</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code>sudo yum install -y chromium
</code></pre></div><p>2.使用yum安装软件依赖出错，一直提示找不到软件包</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code>[root<span class="token operator">@</span>localhost video-url-analysis]<span class="token comment"># sudo yum install -y chromium</span>
<span class="token target symbol">上次元数据过期检查：0</span><span class="token punctuation">:</span>00<span class="token punctuation">:</span>47 前，执行于 2022年01月20日 星期四 21时35分27秒。
<span class="token target symbol">未找到匹配的参数</span><span class="token punctuation">:</span> chromium
<span class="token target symbol">错误：没有任何匹配</span><span class="token punctuation">:</span> chromium
</code></pre></div><p>原因是<code>CentOS 8</code>没有安装 <code>epel</code> 源的问题,安装 <code>epel</code> 源后问题解决:
<code>yum install epel-release</code></p> <h2 id="代码"><a href="#代码" class="header-anchor">#</a> 代码</h2> <p>完整代码已上传 <a href="https://link.segmentfault.com/?enc=pYKcxvwAdhoIiBSZFUdgfA%3D%3D.P%2B%2BR5euwxF8SgVmPH67B3wqPxguuZHJVxjkYzlYmLDbYqJW7dROAxDIwZVHx9UG8" target="_blank" rel="noopener noreferrer">https://github.com/zhaosheng808/video-grab<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 欢迎 star，仅供学习参考,切勿用于非法途径</p> <p>1.安装依赖</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code>npm install
</code></pre></div><p>2.本地开发</p> <div class="language-routeros extra-class"><pre class="language-text"><code>npm run dev
</code></pre></div><p>打开本地网页访问：localhost:18000</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>windows环境下开发比较顺利，由于本人是前端切图仔，服务器接触较少，所以linux服务端部署遇到的问题较多，因此记录一下解决问题的过程，方便后续开发者遇到问题能够顺利解决。
服务端知识有所欠缺，如有不足，还请海涵！</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/interview/3-node/third-part-api.html" class="prev">
          第三方服务接入
        </a></span> <span class="next"><a href="/interview/4-demo/docker-mysql.html">
          Docker部署MySQL服务
        </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:0;" data-v-070bf1cb></ul></main></div> <!----></div></div></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/interview/assets/js/app.8b7001fa.js" defer></script><script src="/interview/assets/js/3.09e61146.js" defer></script><script src="/interview/assets/js/1.645caf6f.js" defer></script><script src="/interview/assets/js/31.6e4c0475.js" defer></script>
  </body>
</html>
